//*******************************************************************
// File: image/sys/rho.c
// Author: YD Liu
// Created: September 21 2015
// Comment: kit of rho domain
//*******************************************************************

#include "rho.h"

const double RHO8TABLE[254]={0.834060933333333, 0.924652723809524, 0.946947114285714, 0.958860438095239, 0.966496866666667, 0.971873933333334, 0.975805342857143, 0.978880285714286, 0.981272457142857, 0.983215638095238, 0.984844866666667, 0.986174714285714, 0.987314495238095, 0.988276980952381, 0.989103742857143, 0.989831819047619, 0.990463733333333, 0.991027419047619, 0.991528914285714, 0.991962361904762, 0.992352038095238, 0.992704028571428, 0.993015352380952, 0.993292333333333, 0.993540666666667, 0.993771723809524, 0.993977971428571, 0.994172304761905, 0.994346161904762, 0.994503828571429, 0.994646257142857, 0.994779504761905, 0.995015171428571, 0.995203000000000, 0.995365038095238, 0.995505666666667, 0.995622028571428, 0.995730704761904, 0.995819419047619, 0.995891104761905, 0.995957771428572, 0.996018933333333, 0.996066561904761, 0.996107742857143, 0.996146209523810, 0.996180838095238, 0.996212561904762, 0.996238190476190, 0.996282676190476, 0.996316161904762, 0.996342295238095, 0.996359438095238, 0.996375057142856, 0.996384676190475, 0.996394104761904, 0.996400266666666, 0.996406190476189, 0.996410057142856, 0.996413161904761, 0.996416752380951, 0.996419152380951, 0.996421771428570, 0.996424076190475, 0.996425685714284, 0.996427714285712, 0.996429628571427, 0.996430676190474, 0.996431590476189, 0.996432238095236, 0.996433123809522, 0.996433428571427, 0.996433780952379, 0.996433904761903, 0.996433961904760, 0.996434085714284, 0.996434085714284, 0.996434152380950, 0.996434209523808, 0.996434209523808, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665, 0.996434266666665};

const double RHO16TABLE[254]={0.487178609523810, 0.530235095238095, 0.554740895238095, 0.573434161904762, 0.588667200000000, 0.601652028571428, 0.612941723809524, 0.622896057142857, 0.631768771428572, 0.639846409523810, 0.647251247619048, 0.654035361904762, 0.660321885714286, 0.666153685714286, 0.671631800000000, 0.676824476190476, 0.681715133333334, 0.686310971428572, 0.690693876190476, 0.694827885714285, 0.698794380952381, 0.702624028571429, 0.706271704761905, 0.709747400000000, 0.713098209523810, 0.716325457142857, 0.719426466666667, 0.722408838095238, 0.725292580952381, 0.728107257142857, 0.730798561904762, 0.733420942857143, 0.738440000000000, 0.743192000000000, 0.747646666666667, 0.751898028571429, 0.755942323809524, 0.759796009523810, 0.763473361904762, 0.766969542857143, 0.770359238095238, 0.773610819047619, 0.776723514285715, 0.779740104761905, 0.782613980952381, 0.785408076190477, 0.788089933333333, 0.790686685714286, 0.795631238095238, 0.800262990476191, 0.804634028571429, 0.808765019047619, 0.812717580952381, 0.816423342857143, 0.819931361904762, 0.823306333333334, 0.826507409523810, 0.829598409523809, 0.832544133333333, 0.835375304761905, 0.838083914285714, 0.840662961904762, 0.843161733333334, 0.845560466666667, 0.850125866666667, 0.854367133333333, 0.858329209523810, 0.862030542857143, 0.865517514285714, 0.868814295238095, 0.871946600000000, 0.874906695238096, 0.877720523809524, 0.880381390476190, 0.882929838095238, 0.885354933333333, 0.887661514285714, 0.889852466666667, 0.891976609523809, 0.894010619047619, 0.897806266666667, 0.901341028571429, 0.904601152380952, 0.907629390476191, 0.910465733333333, 0.913108933333334, 0.915581542857143, 0.917924676190476, 0.920150209523809, 0.922227685714286, 0.924205942857143, 0.926080428571429, 0.927859390476191, 0.929566895238095, 0.931170428571429, 0.932703447619048, 0.935598990476190, 0.938239504761904, 0.940662761904761, 0.942915838095238, 0.944997276190476, 0.946912857142857, 0.948707733333333, 0.950378466666667, 0.951955390476191, 0.953438095238095, 0.954830390476191, 0.956144742857143, 0.957387857142857, 0.958560161904762, 0.959680247619048, 0.960737228571429, 0.962722266666666, 0.964518895238095, 0.966154323809524, 0.967666247619048, 0.969048247619048, 0.970319657142858, 0.971505980952381, 0.972595228571429, 0.973618723809524, 0.974559314285714, 0.975466104761904, 0.976306752380953, 0.977097342857143, 0.977847180952381, 0.978548628571428, 0.979212371428571, 0.980428457142857, 0.981512123809524, 0.982497047619047, 0.983396819047619, 0.984194285714286, 0.984941895238096, 0.985620885714286, 0.986248666666666, 0.986827161904762, 0.987358628571429, 0.987852628571428, 0.988301542857143, 0.988721838095238, 0.989113733333333, 0.989477076190476, 0.989826800000000, 0.990456666666667, 0.991010247619048, 0.991505742857143, 0.991942266666666, 0.992330371428571, 0.992678609523809, 0.992984447619048, 0.993265857142857, 0.993515000000000, 0.993743304761905, 0.993953314285714, 0.994141638095238, 0.994318504761904, 0.994480238095238, 0.994622533333333, 0.994755885714286, 0.994991847619048, 0.995185247619047, 0.995348600000000, 0.995489038095238, 0.995608676190476, 0.995718295238095, 0.995806133333333, 0.995881304761905, 0.995948952380952, 0.996008514285714, 0.996060609523809, 0.996102466666667, 0.996139923809524, 0.996176504761904, 0.996207695238095, 0.996234323809523, 0.996279495238095, 0.996314438095238, 0.996341200000000, 0.996359561904762, 0.996374742857142, 0.996385009523809, 0.996394447619047, 0.996401514285714, 0.996407647619047, 0.996411542857142, 0.996414999999999, 0.996417895238094, 0.996420847619047, 0.996422914285713, 0.996425419047618, 0.996427104761904, 0.996429619047618, 0.996431295238094, 0.996432580952380, 0.996433438095237, 0.996434038095237, 0.996434980952380, 0.996435333333332, 0.996435628571427, 0.996435761904761, 0.996435876190475, 0.996435999999999, 0.996435999999999, 0.996436066666665, 0.996436123809523, 0.996436123809523, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380, 0.996436180952380};

const double RHO32TABLE[254]={0.410868771428572, 0.422380542857143, 0.426245428571429, 0.429693276190476, 0.432087780952381, 0.436033733333333, 0.439281485714286, 0.441882361904762, 0.444392980952381, 0.446126895238095, 0.449043571428571, 0.451172038095238, 0.452988152380952, 0.454320380952381, 0.465502628571429, 0.466783580952381, 0.468003438095238, 0.469171000000000, 0.470309876190476, 0.471712438095238, 0.473096723809524, 0.474169533333333, 0.475200238095238, 0.476219866666667, 0.477220228571429, 0.478199914285714, 0.479169590476190, 0.480111295238095, 0.481053219047619, 0.481969552380953, 0.482871257142857, 0.483771580952381, 0.485504257142857, 0.487183590476191, 0.488819085714286, 0.490434990476191, 0.492001523809524, 0.493535057142857, 0.495028190476191, 0.496457561904762, 0.497864600000000, 0.499247285714286, 0.500603685714286, 0.501930714285714, 0.503227961904762, 0.504510361904762, 0.505758447619047, 0.506987247619047, 0.509374400000000, 0.511673114285714, 0.513920628571429, 0.516097647619047, 0.518201523809524, 0.520232495238095, 0.522213723809524, 0.524131838095238, 0.526032733333333, 0.527884514285714, 0.529689885714286, 0.531454190476191, 0.533173695238095, 0.534864428571429, 0.536506333333333, 0.538138552380952, 0.541289161904762, 0.544313380952381, 0.547234990476190, 0.550058095238096, 0.552775419047619, 0.555438533333334, 0.557989038095238, 0.560476828571428, 0.562861895238095, 0.565211647619048, 0.567497152380952, 0.569714885714286, 0.571869476190476, 0.573975228571429, 0.576027257142857, 0.578027819047619, 0.581885990476191, 0.585593914285714, 0.589139876190476, 0.592546285714286, 0.595831352380952, 0.598992676190476, 0.602052819047619, 0.605025057142857, 0.607897200000000, 0.610660133333334, 0.613324952380952, 0.615909561904762, 0.618428219047619, 0.620862514285714, 0.623236647619048, 0.625538361904762, 0.629986733333333, 0.634193390476191, 0.638235685714286, 0.642092866666667, 0.645803790476191, 0.649331866666667, 0.652706923809524, 0.655981009523810, 0.659112266666667, 0.662139514285715, 0.665079628571428, 0.667906742857143, 0.670646638095238, 0.673295609523810, 0.675872914285714, 0.678374085714286, 0.683209085714285, 0.687745361904762, 0.692056523809524, 0.696154895238095, 0.700074723809524, 0.703871685714286, 0.707473685714286, 0.710919200000000, 0.714224857142857, 0.717435152380952, 0.720498114285714, 0.723464857142857, 0.726328504761905, 0.729103914285714, 0.731783323809524, 0.734378590476191, 0.739375952380952, 0.744083228571429, 0.748504095238095, 0.752720038095238, 0.756755476190476, 0.760578866666667, 0.764233266666667, 0.767721895238095, 0.771086419047619, 0.774327609523809, 0.777431504761905, 0.780435361904762, 0.783288933333334, 0.786070428571429, 0.788743352380952, 0.791326657142857, 0.796257266666666, 0.800863561904762, 0.805222590476190, 0.809341476190476, 0.813285933333334, 0.816978847619048, 0.820482171428571, 0.823831171428571, 0.827036857142857, 0.830118314285715, 0.833055542857143, 0.835873247619048, 0.838584266666666, 0.841145276190476, 0.843639742857143, 0.846034514285714, 0.850589371428571, 0.854823828571429, 0.858780114285714, 0.862471123809524, 0.865953752380952, 0.869246580952381, 0.872370495238096, 0.875328609523810, 0.878131580952380, 0.880793733333334, 0.883343428571429, 0.885759333333334, 0.888063000000000, 0.890246866666667, 0.892371771428571, 0.894408200000000, 0.898193276190476, 0.901727971428572, 0.904986152380952, 0.908005171428571, 0.910839152380952, 0.913482485714286, 0.915950866666667, 0.918290238095238, 0.920512676190476, 0.922595885714286, 0.924568866666666, 0.926439771428571, 0.928220857142857, 0.929924876190476, 0.931526895238096, 0.933062400000000, 0.935954542857142, 0.938592019047619, 0.941014638095238, 0.943265619047619, 0.945347828571429, 0.947260923809524, 0.949054923809524, 0.950726466666666, 0.952301714285714, 0.953783780952381, 0.955175990476191, 0.956489904761904, 0.957731590476190, 0.958905285714286, 0.960022371428571, 0.961079095238095, 0.963064095238095, 0.964861647619048, 0.966495809523810, 0.968008057142857, 0.969388800000000, 0.970658904761905, 0.971846333333334, 0.972934133333333, 0.973958019047619, 0.974898561904762, 0.975804333333333, 0.976645190476191, 0.977435619047619, 0.978186523809524, 0.978887685714286, 0.979550257142858, 0.980766409523810, 0.981850180952381, 0.982834742857143, 0.983734047619048, 0.984532323809524, 0.985279495238096, 0.985958142857143, 0.986585580952381, 0.987164400000000, 0.987696895238095, 0.988190542857143, 0.988638761904761, 0.989059257142857, 0.989451980952381, 0.989814209523809, 0.990164019047619, 0.990794266666667, 0.991347152380952, 0.991843114285715, 0.992279609523809, 0.992667266666666, 0.993016019047619, 0.993322085714286, 0.993603419047619, 0.993852533333333, 0.994080780952381, 0.994290838095238, 0.994479190476190, 0.994655961904762, 0.994817771428571, 0.994959876190476};

const int DefaultBZigzagScan[]={0, 4, 1, 5, 8, 2, 9, 6, 12, 3, 10, 13, 7, 14, 11, 15};
const int DefaultMBZigzagScan[]={0, 2, 1, 3, 8, 4, 9, 6, 10, 5, 12, 11, 7, 14, 13, 15};

int getSize(int x){
	return (int)(log(abs(x))/log(2.0)+2.0);
}

double getQnz(int* image, int mb, int dcqp, int lpqp, int hpqp){
	double qnz=0.0;
	int i, j;
	const int dcsf=lookupSF(dcqp);
	const int lpsf=lookupSF(lpqp);
	const int hpsf=lookupSF(hpqp);
	const int stride = 16*16;
	for(i=0;i<mb;i++){
		for(j=0;j<stride;j++){
			int index=i*stride+j;
			//dc
			if(j==0) qnz+=(image[index]/dcsf)?getSize(image[index]/dcsf):0;
			//lp
			else if(j%16==0) qnz+=(image[index]/lpsf)?getSize(image[index]/lpsf):0;
			//hp
			else qnz+=(image[index]/hpsf)?getSize(image[index]/hpsf):0;
		}
	}
	qnz=qnz/mb/16.0/16.0;
	return qnz;
}

double getQz(int* image, int mb, int dcqp, int lpqp, int hpqp){
	double qz=0.0;
	int i, j, k, lpz=0, hpz=0;
	const int dcsf=lookupSF(dcqp);
	const int lpsf=lookupSF(lpqp);
	const int hpsf=lookupSF(hpqp);
	const int stride = 16*16;
	for(i=0;i<mb;i++){
		//dc
		int index=i*stride;
		qz+=(image[index]/dcsf)?0:getSize(1);
		for(j=1;j<16;j++){
			//lp
			index=i*stride+DefaultBZigzagScan[j]*16;
			if(image[index]/lpsf==0){
				lpz++;
			}else{
				if(lpz){
					qz+=getSize(lpz);
					lpz=0;
				}
			}
			//hp
			for(k=1;k<16;k++){
				index=i*stride+DefaultMBZigzagScan[j]*16+DefaultBZigzagScan[k];
				if(image[index]/hpsf==0){
					hpz++;
				}else{
					if(hpz){
						qz+=getSize(hpz);
						hpz=0;
					}
				}
			}
		}
	}
	qz=qz/mb/16.0/16.0;
	return qz;
}

double QP2RHO(int qp, int bits){
    switch(bits){
		case 8:
			return RHO8TABLE[qp-1];
		case 16:
			return RHO16TABLE[qp-1];
		case 32:
		default:
			return RHO32TABLE[qp-1];
	}
}

int RHO2QP(double rho, int bits){
    double* table=(bits==8)?RHO8TABLE:(bits==16)?RHO16TABLE:RHO32TABLE;
	if(rho<0) return table[0];
	if(rho>1) return table[254];
	int min=0,max=254;
	while(max-min>1){
		if(table[(max+min)/2]>rho) max=(max+min)/2;
		else if(table[(max+min)/2]<rho) min=(max+min)/2;
		else return (max+min)/2+1;
	}
	return (rho-table[min]<=table[max]-rho)?min+1:max+1;
}

double getRho(int* image, int mb, int dcqp, int lpqp, int hpqp){
	double rho=0.0;
	int i, j;
	const int dcsf=lookupSF(dcqp);
	const int lpsf=lookupSF(lpqp);
	const int hpsf=lookupSF(hpqp);
	const int stride = 16*16;
	for(i=0;i<mb;i++){
		for(j=0;j<stride;j++){
			int index=i*stride+j;
			//dc
			if(j==0) rho+=(image[index]/dcsf==0);
			//lp
			else if(j%16==0) rho+=(image[index]/lpsf==0);
			//hp
			else rho+=(image[index]/hpsf==0);
		}
	}
	rho=rho/mb/16.0/16.0;
	return rho;
}






int** cutByFraction(CWMImageStrCodec * pSC, int widFrac, int heiFrac){
	int wid=pSC->cmbWidth;
	int hei=pSC->cmbHeight;
	int widMB=wid/widFrac;
	int heiMB=hei/heiFrac;
	int i;
	int ** patchMark=malloc(2*sizeof(int*));
	int *widMark = malloc((widFrac+1) * sizeof(int));
	int *heiMark = malloc((heiFrac+1) * sizeof(int));
	widMark[0]=0;
	for(i=1;i<=widFrac;i++){
		widMark[i]=widMark[i-1]+widMB+((wid-widMark[i-1])%widMB!=0);
	}
	heiMark[0]=0;
	for(i=1;i<=heiFrac;i++){
		heiMark[i]=heiMark[i-1]+heiMB+((hei-heiMark[i-1])%heiMB!=0);
	}
	patchMark[0]=widMark;
	patchMark[1]=heiMark;
	return patchMark;
}

double evaluatePatch(CWMImageStrCodec * pSC, int c, int w, int h, double crt){
	w=(w<=0)?1:w;
	h=(h<=0)?1:h;
	
	int wid=pSC->cmbWidth;
	int hei=pSC->cmbHeight;
	int widFrac, heiFrac;
	
	switch(c){
		case 'p':
			widFrac=(w>wid)?wid:(w<1)?1:w;
			heiFrac=(h>hei)?hei:(h<1)?1:h;
			break;
		case 'm':
		default:
			widFrac=(wid/w>wid)?wid:(wid/w<1)?1:wid/w;
			heiFrac=(hei/h>hei)?hei:(hei/h<1)?1:hei/h;
	}
	
	int i,j,k,l,m;
	const int stride = 16*16;
	int **patchMark=cutByFraction(pSC, widFrac, heiFrac);
	int* widMark=patchMark[0];
	int* heiMark=patchMark[1];
	
	for(i=0;i<=widFrac;i++){
		printf("%d ",widMark[i]);
	}
	printf("\n");
	for(i=0;i<=heiFrac;i++){
		printf("%d ",heiMark[i]);
	}
	printf("\n");
	
	double *sigma2=malloc(widFrac*heiFrac*sizeof(double));
	double *simean=malloc(widFrac*heiFrac*sizeof(double));
	for(i=0;i<heiFrac;i++){
		for(j=0;j<widFrac;j++){
			int addr=i*widFrac+j;
			sigma2[addr]=0.0;
			simean[addr]=0.0;
			for(k=heiMark[i];k<heiMark[i+1];k++){
				for(l=widMark[j];l<widMark[j+1];l++){
					int* pMB = pSC->pTransformedImage+((k+1) * (pSC->cmbWidth+1) + l+1)*stride;
					for (m=1;m<stride;m++)
						sigma2[addr]+=pow((double)(*(pMB+m)-*(pMB)),2)/16.0/16.0/(heiMark[i+1]-heiMark[i])/(widMark[j+1]-widMark[j]);
						if(m!=stride-1)
							simean[addr]+=abs(*(pMB+m+1)-*(pMB+m-1))/(16.0*16.0-2)/(heiMark[i+1]-heiMark[i])/(widMark[j+1]-widMark[j]);
				}
			}
			printf("%d %d %f %f\n",j,i,sigma2[addr],simean[addr]);
		}
	}
	double gm=1.0;
	double sim=0.0;
	for(i=0;i<widFrac*heiFrac;i++){
		gm*=pow(sigma2[i],1.0/widFrac/heiFrac);
		sim+=simean[i]/widFrac/heiFrac;
	}

	printf("%f %f\n",gm,sim);
	
	double *cri=malloc(widFrac*heiFrac*sizeof(double));
	double *cri2=malloc(widFrac*heiFrac*sizeof(double));
	double closestCR=INF;
	for(i=0;i<heiFrac;i++){
		for(j=0;j<widFrac;j++){
			int addr=i*widFrac+j;
			cri[addr]=0.5*log(sigma2[addr]/gm)/log(2.0);
			cri2[addr]=0.5*log(simean[addr]/sim)/log(2.0);
			if(fabs(cri[addr])<fabs(closestCR)){
			//if(fabs(cri2[addr])<fabs(closestCR)){
				closestCR=cri[addr];
				//closestCR=cri2[addr];
				pSC->patch[0]=widMark[j];
				pSC->patch[1]=widMark[j+1];
				pSC->patch[2]=heiMark[i];
				pSC->patch[3]=heiMark[i+1];
			}
			printf("%d\t%d\t%f\t%f\n",widMark[j],heiMark[i],cri[addr],cri2[addr]);
		}
	}
	            // i=2;j=0;
				// pSC->patch[0]=widMark[j];
				// pSC->patch[1]=widMark[j+1];
				// pSC->patch[2]=heiMark[i];
				// pSC->patch[3]=heiMark[i+1];
	
	printf("%d %d %d %d\n",pSC->patch[0],pSC->patch[1],pSC->patch[2],pSC->patch[3]);
	
	return closestCR+crt;
}